// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Organizations/Tenants
model Organization {
  id        String   @id @default(cuid())
  name      String
  settings  String   @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users       User[]
  agents      Agent[]
  assessments Assessment[]
  enrollmentTokens EnrollmentToken[]
  jobs       Job[]

  @@map("organizations")
}

// Users and authentication
model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String
  passwordHash   String    @map("password_hash")
  role           UserRole  @default(USER)
  organizationId String    @map("organization_id")
  lastLogin      DateTime? @map("last_login")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
  VIEWER
}

// Agents and their configurations
model Agent {
  id            String       @id @default(cuid())
  orgId         String       @map("organization_id")
  hostname      String
  version       String?
  status        AgentStatus  @default(OFFLINE)
  lastSeenAt    DateTime?    @map("last_seen")
  capacity      Int          @default(1)
  secretHash    String?
  labels        Json?
  configuration String       @default("{}")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assessments  Assessment[]
  jobs         Job[]

  @@unique([orgId, hostname])
  @@index([orgId], name: "agent_org_idx")
  @@map("agents")
}

enum AgentStatus {
  ONLINE
  OFFLINE
  ERROR
}

model EnrollmentToken {
  id        String   @id @default(cuid())
  orgId     String   @map("organization_id")
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdBy String    @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId], name: "enrollment_token_org_idx")
  @@map("enrollment_tokens")
}

model Job {
  id        String    @id @default(cuid())
  orgId     String    @map("organization_id")
  agentId   String    @map("agent_id")
  type      String
  payload   Json
  status    JobStatus @default(QUEUED)
  attempts  Int       @default(0)
  notBefore DateTime? @map("not_before")
  dedupeKey String?   @map("dedupe_key")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  agent      Agent      @relation(fields: [agentId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  result     JobResult?

  @@index([orgId], name: "jobs_org_idx")
  @@index([agentId], name: "jobs_agent_idx")
  @@index([dedupeKey], name: "jobs_dedupe_idx")
  @@index([orgId, agentId, status], name: "jobs_dequeue_idx")
  @@map("jobs")
}

model JobResult {
  id          String    @id @default(cuid())
  jobId       String    @map("job_id") @unique
  status      JobStatus
  summary     Json
  artifactUrl String?   @map("artifact_url")
  startedAt   DateTime? @map("started_at")
  finishedAt  DateTime? @map("finished_at")

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("job_results")
}

enum JobStatus {
  QUEUED
  DISPATCHED
  RUNNING
  SUCCEEDED
  FAILED
  EXPIRED
}

// Assessment runs
model Assessment {
  id             String            @id @default(cuid())
  organizationId String            @map("organization_id")
  agentId        String            @map("agent_id")
  status         AssessmentStatus  @default(PENDING)
  startTime      DateTime          @map("start_time")
  endTime        DateTime?         @map("end_time")
  metadata       String            @default("{}")
  overallRiskScore Float?          @map("overall_risk_score")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agent        Agent             @relation(fields: [agentId], references: [id], onDelete: Cascade)
  results      AssessmentResult[]
  reports      Report[]

  @@map("assessments")
}

enum AssessmentStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// Individual check results
model AssessmentResult {
  id           String    @id @default(cuid())
  assessmentId String    @map("assessment_id")
  checkType    CheckType @map("check_type")
  resultData   String    @map("result_data")
  riskScore    Float     @map("risk_score")
  riskLevel    RiskLevel @map("risk_level")
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@map("assessment_results")
}

enum CheckType {
  ACCOUNTS_BYPASS_PASS_POLICY
  DC_OPEN_PORTS_CHECK
  DNS_CONFIG_CHECK
  EOL_SOFTWARE_CHECK
  ENABLED_INACTIVE_ACCOUNTS
  NETWORK_PROTOCOLS_CHECK
  PSHELL_EXEC_POLICY_CHECK
  SERVICE_ACCOUNTS_DOMAIN_ADMIN
  PRIVILEGED_ACCOUNTS_NO_EXPIRE
  WIN_FEATURE_SECURITY_CHECK
  WIN_FIREWALL_STATUS_CHECK
  WIN_UPDATE_CHECK
  PASSWORD_CRACK
  KERBEROASTED_ACCOUNTS
  SMB_SIGNING_CHECK
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Generated reports
model Report {
  id               String   @id @default(cuid())
  assessmentId     String   @map("assessment_id")
  title            String
  templateVersion  String   @map("template_version")
  htmlContent      String   @map("html_content")
  organizationName String   @map("organization_name")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@map("reports")
}

// Audit logs for security events
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  action    String
  resource  String?
  details   String   @default("{}")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}